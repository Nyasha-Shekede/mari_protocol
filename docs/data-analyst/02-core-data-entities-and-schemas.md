# Core Data Entities & Schemas

## Scope

- **Goal**
  - Define all core data structures relevant for analysis.
  - Show how on-wire data maps into storage and events.

## Identity & Device Data

- **Device Key Registration** (Core API view)
  - Fields stored in in-memory registry:
    - `kid: string` (8-hex device key ID).
    - `spki: string` (base64-encoded ECDSA SPKI public key for signatures).
    - `encSpki?: string` (optional RSA-OAEP SPKI public key for encryption, for future use).
    - `userId?: string` (optional numeric/string user identifier mapped to `encSpki`).
  - Storage:
    - In-memory Maps in `deviceRegistry`:
      - `deviceKeys: Map<kid, spkiB64>`.
      - `userEncKeys: Map<userId, encSpkiB64>`.

- **Bio Hashes**
  - `senderBioHash: string`, `receiverBioHash: string`.
  - Semantics:
    - Stable per-person identifier derived client-side.
    - Used for linking transactions to logical people without storing raw PII.

## Coupon (Transfer Intent)

- **On-Wire Representation**
  - Scheme-like string (URL):
    - `Mari://xfer?from=...&to=...&val=...&g=...&exp=...&s=...&...`
  - Key parameters:
    - `from: string` → sender bio hash.
    - `to: string` → receiver bio hash.
    - `val: number` → transfer amount.
    - `g: string` → location grid identifier.
    - `exp: number` → expiry timestamp (ms since epoch).
    - `s: string` → motion-derived seal (8-hex value used as numeric code).
    - Additional fields allowed for extensions.

- **Parsed Coupon (Core / Bank View)**
  - Common parsed fields (via shared libs/validators):
    - `senderBioHash: string`.
    - `receiverBioHash: string`.
    - `amount: number`.
    - `grid: string`.
    - `expiry: number`.
    - `seal: string`.

- **Coupon Hash**
  - Definition:
    - `couponHash = sha256(couponString)` (hex-encoded, 64 chars).
  - Uses:
    - Idempotency check in core.
    - Part of HSM increment-key payload.
    - Primary key for joining inference, labels, and transactions.

## Physics Data

- **Client Physics Snapshot**
  - Captured in `physicsData`:
    - `location`:
      - `grid: string` (coarse location cell, aligned with coupon `g`).
    - `motion`:
      - `x: number`, `y: number`, `z: number` (simplified motion vector).
    - `timestamp`:
      - ISO string / epoch (client time).

- **Physics in MongoDB**
  - Embedded under `physicsData` in core `Transaction` documents:
    - `location.grid: string`.
    - `motion.x: number`, `motion.y: number`, `motion.z: number`.
    - `timestamp: Date`.

- **Physics in Validation**
  - Derived parameters:
    - `exp`: coupon expiry.
    - `g`: coupon grid.
    - `s`: coupon seal.
    - `b`: sender bio hash ("bio" dimension).
  - Validation outputs:
    - `isValid: boolean`.
    - `errors: Array<{ type: string }>` with types:
      - `COUPON_PARSE_ERROR`.
      - `TIME_EXPIRED`.
      - `LOCATION_MISMATCH`.
      - `MOTION_MISMATCH`.
      - `BLOOD_MISMATCH` (bio hash mismatch).

## Core Transaction (MongoDB)

- **Collection:** `transactions`
- **Schema Fields:**
  - `transactionId: string`
    - Generated by core: `TXN_<timestamp>_<uuid>`.
    - Unique identifier per transaction.
  - `senderBioHash: string`
  - `receiverBioHash: string`
  - `amount: number`
    - Positive value; currency semantics defined externally.
  - `locationGrid: string`
    - Mirrors coupon grid and/or physics grid.
  - `timestamp: Date`
    - Defaults to `Date.now` at creation.
  - `status: string`
    - Enum: `'PENDING' | 'SETTLED' | 'FAILED'`.
  - `coupon: string`
    - Full coupon string as submitted.
  - `transportMethod: string`
    - Enum: `'SMS' | 'HTTP'`.
    - Indicates which rail originated the transaction.
  - `physicsData: { ... }`
    - Embedded snapshot (see above).
  - Mongoose timestamps:
    - `createdAt`, `updatedAt` (automatic).

## Sentinel Inference Data

- **InferenceRequest (Core → Sentinel)**
  - Fields:
    - `coupon_hash: string` (64-hex).
    - `kid: string` (device key ID).
    - `expiry_ts: number` (ms since epoch).
    - `seal: string` (8-hex).
    - `grid_id: string`.
    - `amount: number`.

- **InferenceResponse (Sentinel → Core)**
  - Fields:
    - `score: number` (0–999 integer).
    - `model_id: string` (current model identifier).

- **Feature Vector (Internal, Sentinel)**
  - Derived numeric features:
    - Hashed `kid` (0–9999).
    - Hashed `seal` (0–9999).
    - Hashed `grid_id` (0–999).
    - `amount`.
    - `timeToExpiry = expiry_ts - now`.
    - `hashSeen` (currently 0, reserved for future replay counts).
    - `coupon_hash` prefix (first 2 hex bytes).
    - `coupon_hash` suffix (last 2 hex bytes).

## Label Events (Training Data)

- **TransactionEvent (Core → RabbitMQ → Trainer)**
  - Fields:
    - `event_id: string` (UUID).
    - `event_type: 'PRE_SETTLEMENT' | 'SETTLEMENT_OUTCOME'`.
    - `coupon_hash: string`.
    - `kid: string`.
    - `expiry_ts: number`.
    - `seal: string`.
    - `grid_id: string`.
    - `amount: number`.
    - `result?: 'SUCCESS' | 'DUPLICATE' | 'INVALID_SIG' | 'ERROR'`.

- **Usage in Trainer**
  - `PRE_SETTLEMENT` events:
    - Stored in-memory keyed by `coupon_hash`.
  - `SETTLEMENT_OUTCOME` events with `result`:
    - Joined with matching `PRE_SETTLEMENT`.
    - Featurized identically to inference.
    - Labeled as:
      - `y = 1` for `SUCCESS`.
      - `y = 0` for other results.

## Settlement & Ledger Data

- **Online Settlement (Increment Key)**
  - HSM increment key payload:
    - `USER_ID: string`.
    - `AMOUNT: number`.
    - `COUPON_HASH: string`.
    - `TIME_NS: number` (nanoseconds).
    - `VERSION: number` (monotone per user).
    - `HSM_KID: string` (HSM key ID).
  - Signature:
    - `SIG: string` (base64, RSA-PSS-SHA256 over canonical JSON).

- **Batch Settlement (Merchant)**
  - Request payload (Core → Bank):
    - `batchId: string`.
    - `merchantId: string` (bank-side ID).
    - `seal: string` (batch seal).
    - `transactions: Array<{ id: string; amount: number; coupon: string }>`.
  - Response payload (Bank → Core → App):
    - `batchId: string`.
    - `processed: number`.
    - `successful: number`.
    - `failed: number`.
    - `totalAmount: number` (net to merchant).
    - `totalCommission: number`.
    - `incrementKey: string` (bank-signed summary key).
    - `transactions: Array<{ transactionId, status, amount?, commissions?, errors? }>`.

## Data Keys for Analysis & Joining

- **Primary Join Keys**
  - `couponHash` / `coupon_hash`.
  - `transactionId`.
  - `event_id`.
  - `USER_ID` for increment keys.

- **Recommended Indexing & Aggregation Keys**
  - `senderBioHash`, `receiverBioHash`.
  - `kid`.
  - `grid_id` / `locationGrid`.
  - Time fields (`createdAt`, `expiry_ts`, `TIME_NS`).
