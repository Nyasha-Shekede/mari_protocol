# Mari Core Server — Updated Architecture (Immediate Finality)

This document describes the Core server’s role and the updated endpoints introduced by the immediate-finality architecture.

## Purpose

- Gatekeeper for all transactions (HTTP and SMS-normalized).
- Validates device signatures and Quantum Seal format.
- Enforces idempotency (rejects duplicates).
- Orchestrates settlement with the Bank HSM and returns a bank-signed Increment Key.

## Key Concepts

- Device Key: ECDSA P-256 keypair generated by the client device. Public key (SPKI) is registered with Core.
- Quantum Seal: 8-hex seal derived from SHA-256(Motion || TIME_NS || Geohash) truncated to 4 bytes (embedded as `s` in coupon).
- Increment Key: `{ payload, SIG }` produced by HSM, authoritative for finality.

## Endpoints

### POST /api/transactions/register-device
Registers the client device public key (SPKI) for signature verification and encryption.

Body:
```
{ "kid": "a1b2c3d4", "spki": "<base64(SPKI)>" }
```

Response:
```
{ "ok": true }
```

### POST /api/transactions
Unified signed intake path (works for HTTP and SMS-normalized payloads).

Body:
```
{
  "from": "1001",
  "to": "1002",
  "amount": 25,
  "grid": "grid123",
  "coupon": "mari://xfer?...&s=1a2b3c4d",
  "kid": "a1b2c3d4",
  "sig": "<base64 signature over canonical JSON>"
}
```

Validations:
- Signature over canonical payload `{amount,coupon,from,grid,to}` using registered SPKI.
- `s` must be 8 hex chars.
- Idempotency: `couponHash = SHA-256(coupon)` is rejected if already seen.

Settlement:
- Calls Bank HSM to issue an increment key.

Response:
```
{ "ok": true, "couponHash": "...", "incrementKey": "..." }
```

## SMS Webhook (Mock)

A separate SMS gateway can normalize inbound SMS to `POST /api/transactions`.

## Security Notes

- Do not update client balances without an HSM-signed Increment Key.
- Persist idempotency data and device key registrations in production storage.

## Removal Summary

- Penalties endpoints and physics validation middleware removed.
- No pending/batch flows. Immediate finality only.
